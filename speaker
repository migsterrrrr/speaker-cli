#!/bin/bash
# speaker ‚Äî Search 756M+ B2B person profiles from your terminal.
# Public data only. SQL-native interface.

set -e

# --- Config ---
VERSION="1.5.0"
REPO_URL="https://raw.githubusercontent.com/migsterrrrr/speaker-cli/main"
API_URL="https://api.speaker.sh"
CONFIG_DIR="$HOME/.speaker"
CONFIG_FILE="$CONFIG_DIR/config"

# --- Version check (non-blocking, background) ---
check_version() {
    local latest
    latest=$(curl -sf --max-time 5 -H "Cache-Control: no-cache" "$REPO_URL/VERSION" 2>/dev/null)
    if [[ -n "$latest" && "$latest" != "$VERSION" ]]; then
        echo ""
        echo "  ‚ö° Update available: $VERSION ‚Üí $latest"
        echo "     Run: speaker update"
        echo ""
    fi
}

cmd_update() {
    echo "Updating speaker CLI..."
    curl -sL "$REPO_URL/speaker" -o /usr/local/bin/speaker
    chmod +x /usr/local/bin/speaker
    curl -sL "$REPO_URL/SPEAKER.md" -o "$CONFIG_DIR/SPEAKER.md" 2>/dev/null
    local new_ver=$(grep '^VERSION=' /usr/local/bin/speaker | cut -d'"' -f2)
    echo "‚úì Updated to v${new_ver}"
}

# --- Helpers ---
get_key() {
    if [[ -f "$CONFIG_FILE" ]]; then
        cat "$CONFIG_FILE"
    else
        echo ""
    fi
}

require_key() {
    local key=$(get_key)
    if [[ -z "$key" ]]; then
        echo "Not logged in. Run 'speaker signup' or 'speaker login' first." >&2
        exit 1
    fi
    echo "$key"
}

check_auth() {
    if [[ ! -f "$CONFIG_FILE" ]] || [[ -z "$(cat "$CONFIG_FILE")" ]]; then
        echo "Not logged in. Run 'speaker signup' or 'speaker login' first."
        exit 1
    fi
}

# --- Commands ---
cmd_signup() {
    local email="$1"
    local invite_code="$2"

    # Interactive if args not provided
    if [[ -z "$email" ]]; then
        echo "Create a new account"
        echo ""
        read -p "Email: " email
    fi
    if [[ -z "$invite_code" ]]; then
        read -p "Invite code: " invite_code
    fi

    if [[ -z "$email" || -z "$invite_code" ]]; then
        echo "Error: email and invite code required"
        exit 1
    fi

    local resp
    resp=$(curl -sf "$API_URL/signup" \
        -H "Content-Type: application/json" \
        -d "{\"email\":\"$email\",\"invite_code\":\"$invite_code\"}" 2>&1)

    if [[ $? -ne 0 ]]; then
        local detail=$(echo "$resp" | grep -o '"detail":"[^"]*"' | cut -d'"' -f4)
        echo "Error: ${detail:-signup failed}"
        exit 1
    fi

    local key=$(echo "$resp" | grep -o '"api_key":"[^"]*"' | cut -d'"' -f4)
    if [[ -z "$key" ]]; then
        echo "Error: unexpected response"
        exit 1
    fi

    mkdir -p "$CONFIG_DIR"
    echo "$key" > "$CONFIG_FILE"
    chmod 600 "$CONFIG_FILE"

    cat << 'WELCOME'

    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ                                                                 ‚îÇ
    ‚îÇ   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó       ‚îÇ
    ‚îÇ   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó      ‚îÇ
    ‚îÇ   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù      ‚îÇ
    ‚îÇ   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó      ‚îÇ
    ‚îÇ   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë      ‚îÇ
    ‚îÇ   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù      ‚îÇ
    ‚îÇ                                                  speaker.sh     ‚îÇ
    ‚îÇ                                                                 ‚îÇ
    ‚îÇ   "The enemy's gate is down." ‚Äî Ender Wiggin                    ‚îÇ
    ‚îÇ                                                                 ‚îÇ
    ‚îÇ   756M people. SQL-native. Invite-only.                         ‚îÇ
    ‚îÇ                                                                 ‚îÇ
    ‚îÇ   Your agent should read: ~/.speaker/SPEAKER.md                 ‚îÇ
    ‚îÇ   Quick start: speaker help                                     ‚îÇ
    ‚îÇ                                                                 ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
WELCOME
}

cmd_login() {
    # Accept key directly: speaker login sk-abc123
    if [[ -n "$1" ]]; then
        # Validate the key
        local resp
        resp=$(curl -sf "$API_URL/health" -H "X-API-Key: $1" 2>&1)
        mkdir -p "$CONFIG_DIR"
        echo "$1" > "$CONFIG_FILE"
        chmod 600 "$CONFIG_FILE"
        echo "‚úì API key saved. You're in."
        return
    fi

    echo "Log in to your account"
    echo ""
    read -p "Email: " email
    read -sp "Password: " password
    echo ""

    local resp
    resp=$(curl -sf "$API_URL/login" \
        -H "Content-Type: application/json" \
        -d "{\"email\":\"$email\",\"password\":\"$password\"}" 2>&1)

    if [[ $? -ne 0 ]]; then
        echo "Error: invalid email or password"
        exit 1
    fi

    local key=$(echo "$resp" | grep -o '"api_key":"[^"]*"' | cut -d'"' -f4)
    if [[ -z "$key" ]]; then
        echo "Error: unexpected response"
        exit 1
    fi

    mkdir -p "$CONFIG_DIR"
    echo "$key" > "$CONFIG_FILE"
    chmod 600 "$CONFIG_FILE"
    echo "‚úì Logged in. API key saved."
}

cmd_status() {
    read -p "Email: " email

    local resp
    resp=$(curl -sf "$API_URL/status" \
        -H "Content-Type: application/json" \
        -d "{\"email\":\"$email\"}" 2>&1)

    if [[ $? -ne 0 ]]; then
        local detail=$(echo "$resp" | grep -o '"detail":"[^"]*"' | cut -d'"' -f4)
        echo "${detail:-Could not check status}"
        exit 1
    fi

    local status=$(echo "$resp" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)

    if [[ "$status" == "approved" ]]; then
        local key=$(echo "$resp" | grep -o '"api_key":"[^"]*"' | cut -d'"' -f4)
        mkdir -p "$CONFIG_DIR"
        echo "$key" > "$CONFIG_FILE"
        chmod 600 "$CONFIG_FILE"
        echo "‚úì Approved! API key saved. You're in."
        echo ""
        echo "Try:"
        echo "  speaker count"
        echo "  speaker query \"SELECT first, last, headline FROM people WHERE cc = 'uk' LIMIT 10\""
    else
        echo "‚è≥ Account is still pending approval. Check back later."
    fi
}

cmd_logout() {
    rm -f "$CONFIG_FILE"
    echo "‚úì Logged out. API key removed."
}

cmd_query() {
    check_auth
    local key=$(get_key)
    local sql="$1"

    if [[ -z "$sql" ]]; then
        echo "Usage: speaker query \"SELECT ...\""
        exit 1
    fi

    # Option 3: hint on first query of session
    local session_marker="$CONFIG_DIR/.session_$$"
    if [[ ! -f "$CONFIG_DIR/.session_hint" ]] || [[ $(find "$CONFIG_DIR/.session_hint" -mmin +60 2>/dev/null) ]]; then
        echo "üí° Tip: Read ~/.speaker/SPEAKER.md for query patterns and critical pitfalls." >&2
        echo "" >&2
        touch "$CONFIG_DIR/.session_hint"
    fi

    local resp http_code
    resp=$(curl -s -w "\n%{http_code}" --max-time 60 "$API_URL/query" \
        -H "X-API-Key: $key" \
        -d "$sql" 2>&1)

    http_code=$(echo "$resp" | tail -1)
    resp=$(echo "$resp" | sed '$d')

    if [[ "$http_code" != "200" ]]; then
        local detail=$(echo "$resp" | grep -o '"detail":"[^"]*"' | cut -d'"' -f4)
        if [[ "$http_code" == "429" ]]; then
            echo "Error: Rate limit hit. Wait a moment and try again." >&2
        elif [[ "$http_code" == "000" ]]; then
            echo "Error: Could not connect to server. Check your internet connection." >&2
        elif [[ -n "$detail" ]]; then
            echo "Error: $detail" >&2
        else
            echo "Error: query failed (HTTP $http_code)" >&2
        fi
        exit 1
    fi

    # Option 4: hint on empty results
    if [[ -z "$resp" ]] || [[ "$resp" == "" ]]; then
        echo "No results. Check ~/.speaker/SPEAKER.md for search tips and common pitfalls." >&2
        return
    fi

    # Format output
    if [[ -t 1 ]]; then
        # Terminal: pretty print
        echo "$resp" | while IFS= read -r line; do
            echo "$line" | python3 -m json.tool 2>/dev/null || echo "$line"
        done
    else
        # Piped: raw JSON lines
        echo "$resp"
    fi
}

cmd_count() {
    check_auth
    local key=$(get_key)
    local resp
    resp=$(curl -sf "$API_URL/query" \
        -H "X-API-Key: $key" \
        -d "SELECT formatReadableQuantity(count()) as profiles FROM people")
    local count=$(echo "$resp" | grep -o '"profiles":"[^"]*"' | cut -d'"' -f4)
    echo "${count:-Error: could not get count}"
}

cmd_schema() {
    check_auth
    local key=$(get_key)
    echo ""
    echo "TABLE: people"
    echo ""
    echo "PERSON FIELDS:"
    echo "  first        String       First name"
    echo "  last         String       Last name"
    echo "  slug         String       Unique profile identifier"
    echo "  headline     String       Current professional headline"
    echo "  loc          String       Location (city, country)"
    echo "  cc           String       Country code (lowercase: us, uk, de, fr)"
    echo "  email        String       Email address (where available)"
    echo "  bio          String       Short bio (max 200 chars)"
    echo ""
    echo "ROLES (work history array ‚Äî most recent first):"
    echo "  roles[].title    Job title"
    echo "  roles[].org      Company name"
    echo "  roles[].slug     Company identifier"
    echo "  roles[].web      Company website domain"
    echo "  roles[].cc       Country code of role"
    echo "  roles[].start    Start date (YYYY-MM)"
    echo "  roles[].end      End date (YYYY-MM, NULL = current)"
    echo "  roles[].desc     Role description (max 120 chars)"
    echo ""
    echo "EDUCATION (array):"
    echo "  edu[].school     Institution name"
    echo "  edu[].deg        Degree and field"
    echo "  edu[].slug       Institution identifier"
    echo ""
    echo "NOTES:"
    echo "  - Country codes are lowercase: us, uk, de, fr, at, ch, in, br"
    echo "  - 'uk' not 'gb' for United Kingdom"
    echo "  - Current role: roles[1] or WHERE r.end IS NULL"
    echo "  - ILIKE '%CTO%' also matches 'Director' ‚Äî use LIKE for exact"
    echo ""

    local resp
    resp=$(curl -sf "$API_URL/query" \
        -H "X-API-Key: $key" \
        -d "SELECT cc, count() as profiles FROM people GROUP BY cc ORDER BY profiles DESC LIMIT 15")
    echo "TOP COUNTRIES:"
    echo "$resp" | while IFS= read -r line; do
        local cc=$(echo "$line" | grep -o '"cc":"[^"]*"' | cut -d'"' -f4)
        local cnt=$(echo "$line" | grep -o '"profiles":[0-9]*' | cut -d: -f2)
        if [[ -n "$cc" && -n "$cnt" ]]; then
            printf "  %-6s %'d\n" "$cc" "$cnt"
        fi
    done
    echo ""
}

cmd_help() {
    cat << 'EOF'
speaker ‚Äî Find anyone. 756M people, searchable by any B2B field, via SQL.
          The enemy's gate is down.

COMMANDS:
  speaker signup                  Sign up with invite code
  speaker signup <email> <code>   Sign up non-interactively
  speaker login <api-key>         Log in on another machine
  speaker query "SQL"             Run a SQL query
  speaker count                   Total profiles
  speaker schema                  Show table structure
  speaker logout                  Remove credentials
  speaker update                  Update to latest version

TABLES:
  people_roles    1.36B rows
  people          756M rows

LIMITS:
  Max 1,000 rows per query. Max 5,000 queries per day.

‚ö†Ô∏è  Read ~/.speaker/SPEAKER.md before querying.
    It has the schema, field names, query patterns, and critical pitfalls.
    Queries will return bad results without it.
EOF
}

# --- Main ---
CMD="${1:-help}"

case "$CMD" in
    signup)         cmd_signup "$2" "$3" ;;
    status)         cmd_status ;;
    login)          cmd_login "$2" ;;
    logout)         cmd_logout ;;
    update)         cmd_update ; exit 0 ;;
    query|q)        cmd_query "$2" ;;
    count|c)        cmd_count ;;
    schema|s)       cmd_schema ;;
    help|--help|-h) cmd_help ;;
    *)
        if [[ "$CMD" =~ ^[Ss][Ee][Ll][Ee][Cc][Tt] ]]; then
            cmd_query "$CMD"
        else
            echo "Unknown command: $CMD"
            echo "Run 'speaker help' for usage."
            exit 1
        fi
        ;;
esac

# Check for updates in background (don't slow down the command)
check_version &
